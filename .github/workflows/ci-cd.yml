# ğŸš€ CI/CD Pipeline for Shopping Online Backend
# Tá»± Ä‘á»™ng build, test vÃ  deploy khi cÃ³ commit má»›i

name: 'Shopping Online Backend CI/CD'

# Khi nÃ o pipeline sáº½ cháº¡y
on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]

# Variables mÃ´i trÆ°á»ng
env:
  DOTNET_VERSION: '8.0.x'
  PROJECT_PATH: './ShoppingOnline.API'
  ARTIFACT_NAME: 'shopping-online-api'

# Jobs pipeline
jobs:
  # Job 1: Build vÃ  Test
  build-and-test:
    name: 'ğŸ—ï¸ Build & Test'
    runs-on: ubuntu-latest
    
    steps:
    # BÆ°á»›c 1: Checkout source code
    - name: 'ğŸ“¥ Checkout Code'
      uses: actions/checkout@v4
      
    # BÆ°á»›c 2: Setup .NET SDK
    - name: 'âš™ï¸ Setup .NET ${{ env.DOTNET_VERSION }}'
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    # BÆ°á»›c 3: Cache dependencies Ä‘á»ƒ build nhanh hÆ¡n
    - name: 'ğŸ“¦ Cache NuGet packages'
      uses: actions/cache@v3
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-
          
    # BÆ°á»›c 4: Restore dependencies
    - name: 'ğŸ“¦ Restore Dependencies'
      run: |
        cd ${{ env.PROJECT_PATH }}
        dotnet restore
        
    # BÆ°á»›c 5: Build project
    - name: 'ğŸ—ï¸ Build Project'
      run: |
        cd ${{ env.PROJECT_PATH }}
        dotnet build --configuration Release --no-restore
        
    # BÆ°á»›c 6: Run tests (náº¿u cÃ³)
    - name: 'ğŸ§ª Run Tests'
      run: |
        cd ${{ env.PROJECT_PATH }}
        # Kiá»ƒm tra cÃ³ test project khÃ´ng
        if find . -name "*.Tests.csproj" -o -name "*Test*.csproj" | grep -q .; then
          dotnet test --configuration Release --no-build --verbosity normal --collect:"XPlat Code Coverage"
        else
          echo "No test projects found. Skipping tests."
        fi
        
    # BÆ°á»›c 7: Code Coverage (náº¿u cÃ³ tests)
    - name: 'ğŸ“Š Upload Coverage Reports'
      if: success()
      uses: codecov/codecov-action@v3
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        fail_ci_if_error: false
        
    # BÆ°á»›c 8: Security Scan
    - name: 'ğŸ”’ Security Vulnerability Scan'
      run: |
        cd ${{ env.PROJECT_PATH }}
        dotnet list package --vulnerable --include-transitive || true
        
    # BÆ°á»›c 9: Publish artifacts
    - name: 'ğŸ“¦ Publish Application'
      run: |
        cd ${{ env.PROJECT_PATH }}
        dotnet publish --configuration Release --output ./publish --no-build
        
    # BÆ°á»›c 10: Upload build artifacts
    - name: 'â¬†ï¸ Upload Build Artifacts'
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.ARTIFACT_NAME }}
        path: ${{ env.PROJECT_PATH }}/publish/
        retention-days: 30

  # Job 2: Docker Build (cháº¡y sau khi build thÃ nh cÃ´ng)
  docker-build:
    name: 'ğŸ³ Docker Build'
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    # BÆ°á»›c 1: Checkout code
    - name: 'ğŸ“¥ Checkout Code'
      uses: actions/checkout@v4
      
    # BÆ°á»›c 2: Setup Docker Buildx
    - name: 'ğŸ³ Set up Docker Buildx'
      uses: docker/setup-buildx-action@v3
      
    # BÆ°á»›c 3: Login to Docker Hub (dÃ¹ng secrets)
    - name: 'ğŸ” Login to Docker Hub'
      if: github.event_name != 'pull_request'
      uses: docker/login-action@v3
      with:
        username: ttphatt2403
        password: ${{ secrets.DOCKER_PASSWORD }}
        
    # BÆ°á»›c 4: Build Docker image
    - name: 'ğŸ—ï¸ Build Docker Image'
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        platforms: linux/amd64
        push: false
        tags: |
          shopping-online-api:latest
          shopping-online-api:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  # Job 3: Deploy to Staging (chá»‰ khi push vÃ o main/master)
  deploy-staging:
    name: 'ğŸš€ Deploy to Staging'
    runs-on: ubuntu-latest
    needs: [build-and-test, docker-build]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    environment: staging
    
    steps:
    # BÆ°á»›c 1: Download artifacts
    - name: 'ğŸ“¥ Download Build Artifacts'
      uses: actions/download-artifact@v3
      with:
        name: ${{ env.ARTIFACT_NAME }}
        path: ./artifacts
        
    # BÆ°á»›c 2: Deploy notification
    - name: 'ğŸ“¢ Deploy Notification'
      run: |
        echo "ğŸš€ Deploying Shopping Online API to Staging..."
        echo "ğŸ“¦ Artifact size: $(du -sh ./artifacts | cut -f1)"
        echo "ğŸ”— Commit: ${{ github.sha }}"
        echo "ğŸ‘¤ Author: ${{ github.actor }}"
        
    # BÆ°á»›c 3: Simulate deployment (thay báº±ng actual deployment commands)
    - name: 'ğŸ¯ Deploy Application'
      run: |
        echo "Deploying to staging environment..."
        echo "Application deployed successfully!"
        echo "ğŸŒ Staging URL: https://staging-shopping-api.yourdomain.com"

  # Job 4: Production Deployment (manual approval required)
  deploy-production:
    name: 'ğŸ† Deploy to Production'
    runs-on: ubuntu-latest
    needs: deploy-staging
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    environment: production
    
    steps:
    # BÆ°á»›c 1: Production deployment
    - name: 'ğŸ† Deploy to Production'
      run: |
        echo "ğŸš€ Deploying to Production Environment..."
        echo "âœ… Production deployment completed!"
        echo "ğŸŒ Production URL: https://api.yourdomain.com"

# Notification job (cháº¡y cuá»‘i cÃ¹ng)
  notify:
    name: 'ğŸ“¢ Notifications'
    runs-on: ubuntu-latest
    needs: [build-and-test, docker-build]
    if: always()
    
    steps:
    - name: 'ğŸ“¢ Pipeline Status Notification'
      run: |
        if [ "${{ needs.build-and-test.result }}" == "success" ]; then
          echo "âœ… Build & Test: SUCCESS"
        else
          echo "âŒ Build & Test: FAILED"
        fi
        
        if [ "${{ needs.docker-build.result }}" == "success" ]; then
          echo "âœ… Docker Build: SUCCESS"
        else
          echo "âš ï¸ Docker Build: SKIPPED/FAILED"
        fi
        
        echo "ğŸ“Š Pipeline completed for commit: ${{ github.sha }}"
        echo "ğŸ‘¤ Triggered by: ${{ github.actor }}"
        echo "ğŸ”— Repository: ${{ github.repository }}"
